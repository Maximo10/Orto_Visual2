"use strict";
const mysql = require('mysql2/promise');
const prompt = require('prompt-sync')();

let lista_cartas = [];

/* Configuración de conexión */
const dbConfig = {
    host: 'localhost',
    user: 'root',
    password: '',
    database: 'Gestion',
};

async function conectarBD() {
    const connection = await mysql.createConnection(dbConfig);
    return connection;
}

/* Cargar datos desde la BD */
async function leerdatos() {
    try {
        const connection = await conectarBD();
        const [rows] = await connection.execute('SELECT * FROM Empleado');
        lista_cartas = rows.map(row => ({
            id: row.id,
            nombre: row.Nombre,
            apellidos: row.Apellidos,
            edad: row.Edad,
            departamento: row.Departamento,
            posicion: row.Posicion
        }));
        console.log("Datos cargados desde la base de datos...");
        await connection.end();
    } catch (err) {
        console.error("Error al leer datos:", err);
    }
}

/* Guardar datos en la BD */
async function guardardatos() {
    try {
        const connection = await conectarBD();
        for (let ficha of lista_cartas) {
            await connection.execute(
                'INSERT INTO Empleado (Nombre, Apellidos, Edad, Departamento, Posicion) VALUES (?, ?, ?, ?, ?)',
                [ficha.nombre, ficha.apellidos, ficha.edad, ficha.departamento, ficha.posicion]
            );
        }
        await connection.end();
        console.log("Datos guardados en la base de datos...");
    } catch (err) {
        console.error("Error al guardar datos:", err);
    }
}

/* Funciones CRUD */
async function alta_ficha() {
    const nombre = prompt("Ingrese Nombre: ");
    const apellidos = prompt("Ingrese Apellido: ");
    const edad = parseInt(prompt("Ingrese Edad: "));
    const departamento = prompt("Ingrese Departamento: ");
    const posicion = prompt("Ingrese Posicion: ");

    if (isNaN(edad) || edad <= 0) {
        console.log("Error, la edad es inválida....");
        await alta_ficha();
        return;
    }

    try {
        const connection = await conectarBD();
        const [result] = await connection.execute(
            'INSERT INTO Empleado (Nombre, Apellidos, Edad, Departamento, Posicion) VALUES (?, ?, ?, ?, ?)',
            [nombre, apellidos, edad, departamento, posicion]
        );
        let ficha = {id:result.insertId, nombre, apellidos, edad, departamento, posicion };
        lista_cartas.push(ficha);
        await connection.end();
        console.log("Nueva ficha agregada con ID autoincremental...");
    } catch (err) {
        console.error("Error al agregar ficha:", err);
    }
}


function mostrar() {
    console.log("Opciones de visualización \n1.Mostrar todos \n2.Busqueda por nombre \n3.Volver");
    let opcion = prompt("Seleccione opción: ");
    switch (opcion) {
        case "1":
            console.log(lista_cartas);
            break;
        case "2":
            let nombre = prompt("Nombre a buscar: ").toLowerCase();
            let objetivo = lista_cartas.filter(c => c.nombre.toLowerCase() === nombre);
            if (objetivo.length > 0) console.log(objetivo);
            else console.log("No se ha encontrado la ficha deseada....");
            break;
        default:
            console.log("Error con el dato....");
            break;
    }
}

async function modificar() {
    lista_cartas.forEach((c, i) => console.log(`${i + 1} - ${c.nombre} - ${c.apellidos}`));
    let ide = parseInt(prompt("Ingrese el número de la ficha a modificar: ")) - 1;

    if (ide >= 0 && ide < lista_cartas.length) {
        let ficha = lista_cartas[ide];
        console.log("1. Nombre \n2. Apellido \n3. Edad \n4. Departamento \n5. Posición");
        let opcion = parseInt(prompt("Seleccione apartado a modificar: "));
        switch (opcion) {
            case 1: ficha.nombre = prompt("Nuevo Nombre: "); break;
            case 2: ficha.apellidos = prompt("Nuevo Apellido: "); break;
            case 3: ficha.edad = parseInt(prompt("Nueva Edad: ")); break;
            case 4: ficha.departamento = prompt("Nuevo Departamento: "); break;
            case 5: ficha.posicion = prompt("Nueva Posición: "); break;
            default: console.log("Opción Inválida...."); return;
        }

        try {
            const connection = await conectarBD();
            await connection.execute(
                'UPDATE Empleado SET Nombre = ?, Apellidos = ?, Edad = ?, Departamento = ?, Posicion = ? WHERE id = ?',
                [ficha.nombre, ficha.apellidos, ficha.edad, ficha.departamento, ficha.posicion, ficha.id]
            );
            await connection.end();
            console.log("Ficha modificada correctamente...");
        } catch (err) {
            console.error("Error al modificar ficha:", err);
        }
    } else {
        console.log("Error, opción inválida");
    }
}

async function borra() {
    lista_cartas.forEach((c, i) => 
        console.log(`${i + 1} - ${c.nombre} - ${c.apellidos}`)
    );
    let num = parseInt(prompt("Ingrese el número de ficha a borrar: ")) - 1;

    if (num >= 0 && num < lista_cartas.length) {
        let ficha = lista_cartas[num];
        let confi = prompt(`Eliminar a ${ficha.nombre}? (Si/No): `);
        if (confi.toLowerCase() === "si") {
            try {
                const connection = await conectarBD();
                await connection.execute('DELETE FROM Empleado WHERE id = ?', [ficha.id]);
                await connection.end();
                lista_cartas.splice(num, 1);
                console.log("Ficha eliminada correctamente...");
            } catch (err) {
                console.error("Error al eliminar ficha:", err);
            }
        }
    } else {
        console.log("Ficha inexistente...");
    }
}


/* Menú principal */
async function menu_princi() {
    let fin = false;
    while (!fin) {
        console.log("\n=== Menu Principal ===\n1.Alta Ficha \n2.Mostrar \n3.Modificar \n4.Borrado \n5.Salir");
        let opcion = prompt("Seleccione opción: ");
        switch (opcion) {
            case "1":
                await alta_ficha(); 
                break;
            case "2":
                mostrar(); 
                break;
            case "3":
                await modificar(); 
                break;
            case "4":
                await borra(); 
                break;
            case "5":
                await guardardatos();
                console.log("Saliendo.....");
                fin = true;
                break;
            default: 
                console.log("Opción Inválida");
                break;
        }
    }
}

/* Inicio del programa */
(async () => {
    await leerdatos();
    await menu_princi();
})();
